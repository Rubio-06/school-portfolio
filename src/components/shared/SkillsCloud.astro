---
import type { Skill } from "@/types/skills";
import { skillsConfig } from "@config/skills";

const currentYear = new Date().getFullYear();

// Calculer la taille en fonction du niveau et de l'expérience
const getSkillSize = (skill: Skill) => {
  const yearsActive = (skill.endYear || currentYear) - skill.startYear;
  const sizeBase = skill.level * 0.8 + yearsActive * 0.2;
  return Math.max(1, Math.min(3, sizeBase));
};
---

<section class="relative py-20">
  <div class="relative z-10 container mx-auto px-8">
    <!-- Header -->
    <div class="mb-16 text-center">
      <h2 data-skills-title class="mb-4 text-4xl font-bold text-white md:text-5xl">
        Mes Compétences
      </h2>
      <p data-skills-subtitle class="text-xl text-gray-400">
        Cliquez sur une compétence pour en savoir plus
      </p>
    </div>

    <!-- Skills Cloud -->
    <div class="relative mx-auto max-w-6xl">
      <div class="flex flex-wrap items-center justify-center gap-6 p-8" data-skills-cloud>
        {
          skillsConfig.skills.map((skill, index) => {
            const size = getSkillSize(skill);
            const category = skillsConfig.categories.find((cat) => cat.id === skill.category);
            const yearsActive = (skill.endYear || currentYear) - skill.startYear;

            return (
              <button
                data-skill-item
                data-skill-name={skill.name}
                data-skill-index={index}
                class="group relative cursor-pointer rounded-2xl border-2 border-white/10 bg-white/5 px-6 py-4 backdrop-blur-sm transition-all duration-300 hover:scale-110 hover:border-white/30 hover:bg-white/10"
                style={`font-size: ${size}rem`}
              >
                <div class="flex items-center gap-3">
                  <img
                    src={skill.icon}
                    alt={skill.name}
                    class="h-8 w-8 transition-transform duration-300 group-hover:scale-125"
                    style={`width: ${size * 1.5}rem; height: ${size * 1.5}rem`}
                  />
                  <span
                    class={`bg-gradient-to-r font-bold ${category?.color || "from-white to-gray-300"} bg-clip-text text-transparent`}
                  >
                    {skill.name}
                  </span>
                </div>

                {/* Card detail popup */}
                <div
                  data-skill-card
                  class="pointer-events-none absolute top-full left-1/2 z-50 mt-4 w-80 -translate-x-1/2 rounded-xl border border-white/20 bg-slate-800/95 p-6 opacity-0 shadow-2xl backdrop-blur-lg transition-all duration-300"
                >
                  <div class="mb-4 flex items-center gap-4">
                    <img src={skill.icon} alt={skill.name} class="h-12 w-12" />
                    <div>
                      <h3 class="text-xl font-bold text-white">{skill.name}</h3>
                      <p class="text-sm text-gray-400">{category?.label}</p>
                    </div>
                  </div>

                  <div class="space-y-3">
                    {/* Période */}
                    <div>
                      <p class="text-sm font-medium text-gray-400">Période</p>
                      <p class="text-white">
                        {skill.startYear} - {skill.endYear || "Aujourd'hui"}
                        <span class="ml-2 text-sm text-gray-400">
                          ({yearsActive} an{yearsActive > 1 ? "s" : ""})
                        </span>
                      </p>
                    </div>

                    {/* Niveau */}
                    <div>
                      <p class="text-sm font-medium text-gray-400">Niveau</p>
                      <div class="mt-1 flex gap-1">
                        {Array.from({ length: 5 }).map((_, i) => (
                          <div
                            class={`h-2 w-full rounded-full ${i < skill.level ? `bg-gradient-to-r ${category?.color}` : "bg-white/10"}`}
                          />
                        ))}
                      </div>
                      <p class="mt-1 text-xs text-gray-400">{skill.level}/5</p>
                    </div>

                    {/* Description */}
                    {skill.description && (
                      <div>
                        <p class="text-sm font-medium text-gray-400">À propos</p>
                        <p class="text-sm text-gray-300">{skill.description}</p>
                      </div>
                    )}
                  </div>
                </div>
              </button>
            );
          })
        }
      </div>
    </div>
  </div>
</section>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // Animation du titre
  gsap.from("[data-skills-title]", {
    scrollTrigger: {
      trigger: "[data-skills-title]",
      start: "top 80%",
    },
    y: 50,
    opacity: 0,
    duration: 0.8,
    ease: "power3.out",
  });

  gsap.from("[data-skills-subtitle]", {
    scrollTrigger: {
      trigger: "[data-skills-subtitle]",
      start: "top 80%",
    },
    y: 30,
    opacity: 0,
    duration: 0.8,
    delay: 0.2,
    ease: "power3.out",
  });

  // Animation des skills en nuage
  gsap.from("[data-skill-item]", {
    scrollTrigger: {
      trigger: "[data-skills-cloud]",
      start: "top 70%",
    },
    scale: 0,
    opacity: 0,
    duration: 0.6,
    stagger: {
      amount: 1,
      from: "random",
    },
    ease: "back.out(1.7)",
  });

  // Gestion des popups au hover
  const skillItems = document.querySelectorAll("[data-skill-item]");

  skillItems.forEach((item) => {
    const card = item.querySelector("[data-skill-card]");

    item.addEventListener("mouseenter", () => {
      gsap.to(card, {
        opacity: 1,
        y: 0,
        duration: 0.3,
        ease: "power2.out",
      });
    });

    item.addEventListener("mouseleave", () => {
      gsap.to(card, {
        opacity: 0,
        y: 10,
        duration: 0.3,
        ease: "power2.in",
      });
    });
  });

  // Animation flottante aléatoire
  skillItems.forEach((item) => {
    const randomDelay = Math.random() * 2;
    const randomDuration = 3 + Math.random() * 2;
    const randomY = -10 + Math.random() * 20;

    gsap.to(item, {
      y: randomY,
      duration: randomDuration,
      repeat: -1,
      yoyo: true,
      ease: "sine.inOut",
      delay: randomDelay,
    });
  });
</script>
